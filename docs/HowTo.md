# Azure IoT Device Simulator (.NET 5) - DPS version - How To


## How to use the Azure IoT Device Simulator?

You can use the source code to compile the application and use it as a regular C# .NET 5 Console application.

If you need detailed documentation about what the Azure IoT Device Simulator is, you can find additional information at:
 - [Readme](../Readme.md)
 - [Help](Help.md)

You can also containerize the simulator. This may be particularly interesting if you want to create a set of simulated devices.
[This folder](https://github.com/jonmikeli/azureiotdevicesimulator5-dps/tree/master/containers) contains same examples about how to do that.

## Docker prerequisites
In order to use a Docker container, you need to check [Docker](https://www.docker.com/) prerequisites.

Do not forget you will need an internet connection with specific open ports:
 - 8883
 - 5671
 - 443
[Ports](https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-protocols) required to communicate with Microsoft Azure IoT Hub.


## Steps to run the simulator
The Azure IoT Device Simulator needs three basic things before starting:
 - settings (need to be updated with proper values)
 - message templates (included by default)
 - deploy the REST API exposing the Azure IoT Hub Service SDK (this is required because module identities cannot be created from the Azure IoT Hub Device SDK). The code is provided. It can also be [containerized](https://github.com/jonmikeli/azureiotdevicesimulator5-dps/tree/master/containers).


### Settings
Settings are based on environment variables and on files (JSON).

Environment variables:
 - ENVIRONMENT (Development, Release, null....or the environments you need to create)
 - PROVISIONING_REGISTRATION_ID, cooresponding to the device Id to be used for the provisioning. It can be provided in the devicesettings.json file too. The PROVISIONING_REGISTRATION_ID value overwrites the settings in the JSON file.

JSON files:
 - [appsettings.json](###appsettings.json)
 - [devicesettings.json](###devicesettings.json)
 - [modulessettings.json](###modulessettings.json)
 - [dpssettings.json](###dpssettings.json)

For details and explanations, see [help](Help.md).

> [!TIP]
> 
> The solution takes into account **settings** depending on the environment.
> It can be set trough the environment variable ENVIRONMENT.
> The solution looks for settings files following the pattern *file.ENVIRONMENT.json* (similar to transformation files).
> Default setting files will be loaded first in case no environment file is found.


### appsettings.json
This file allows to configure system related items (logs, etc, API urls, etc).

**Release**

Minimal logs settings.
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Warning"
    }
  },
  "DeviceManagementServiceSettings": {
    "BaseUrl": "[TO BE REPLACED]",
    "AddModulesToDeviceRoute": "modules/add",
    "AllowAutosignedSSLCertificates": true
  }
}
```

**Development (appsettings.Development.json)**

Detailed logs settings.
```json
{
  "Logging": {
    "Debug": {
      "LogLevel": {
        "Default": "Trace"
      }
    },
    "Console": {
      "IncludeScopes": true,
      "LogLevel": {
        "Default": "Trace"
      }
    },
    "LogLevel": {
      "Default": "Trace",
      "System": "Trace",
      "Microsoft": "Trace"
    }
  },
  "DeviceManagementServiceSettings": {
    "BaseUrl": "[TO BE REPLACED]",
    "AddModulesToDeviceRoute": "modules/add",
    "AllowAutosignedSSLCertificates": true
  }
}
```

### devicesettings.json
This file allows configuring device simulation settings.

```json
{
  "deviceId": "[REQUIRED]",
  "connectionString": "[GENERATED BY THE PROVISIONING PROCESS-NO NEED TO FEED IT]",
  "simulationSettings": {
    "enableLatencyTests": false,
    "latencyTestsFrecuency": 30,
    "enableDevice": true,
    "enableModules": false,
    "enableTelemetryMessages": true,
    "telemetryFrecuency": 10,
    "enableErrorMessages": false,
    "errorFrecuency": 20,
    "enableCommissioningMessages": false,
    "commissioningFrecuency": 30,
    "enableTwinReportedMessages": false,
    "twinReportedMessagesFrecuency": 60,
    "enableReadingTwinProperties": false,
    "enableC2DDirectMethods": true,
    "enableC2DMessages": true,
    "enableTwinPropertiesDesiredChangesNotifications": true
  }
}

```

The device Id is required to feed the provisioning.

### modulessettings.json
This file allows configuring module(s) simulation settings.

```json
{
 "modules":[
    {
      "deviceId": "[FED BY THE PROCESS]",
      "moduleId": "[REQUIRED]",
      "connectionString": "",
      "simulationSettings": {
        "enableLatencyTests": false,
        "latencyTestsFrecuency": 10,
        "enableTelemetryMessages": true,
        "telemetryFrecuency": 20,
        "enableErrorMessages": false,
        "errorFrecuency": 30,
        "enableCommissioningMessages": false,
        "commissioningFrecuency": 60,
        "enableTwinReportedMessages": false,
        "twinReportedMessagesFrecuency": 60,
        "enableReadingTwinProperties": true,
        "enableC2DDirectMethods": true,
        "enableC2DMessages": true,
        "enableTwinPropertiesDesiredChangesNotifications": true
      }
    }
  ]
}

```

### dpssettings.json
This file allows to configure the DPS settings.

```json
{
  "dpsSettings": {
    "enrollmentType": "Group",
    "groupEnrollmentSettings": {
      "securityType": "SymetricKey",
      "symetricKeySettings": {
        "idScope": "[TO BE REPLACED]",
        "primaryKey": "[TO BE REPLACED]",
        "enrollmentType": "Group",
        "globalDeviceEndpoint": "global.azure-devices-provisioning.net",
        "transportType": "Mqtt"
      }
    }
  }
}

```


> NOTE
>
> The implemented code covers group enrollments, with symetric keys and MQTT. Feel free to adapt the code to your own needs. Upcoming iterations will add other options.
> In very secured environments, the primaryKey should not be stored in such a configuration file.


## Message templates
You will find in this section the default templates of the messages sent by the simulator.
You are totally free to change and adapt them to your needs.

> [!WARNING]
> 
> This first version includes a dependency between message templates and message service implementation (randomized values and ID properties).
> For that reason, if the message template is completely reviewed and new randomized properties are added, you will need to either update the existing message service or create yours and update the IoC/DI settings.

### Measured data / telemetry message
```json
{
  "deviceId": "",
  "moduleId": "",
  "timestamp": 0,
  "schemaVersion": "v1.0",
  "messageType": "data",
  "data": [
    {
      "timestamp": 0,
      "propertyName": "P1",
      "propertyValue": 35,
      "propertyUnit": "T",
      "propertyDivFactor": 1
    },
    {
      "timestamp": 0,
      "propertyName": "P2",
      "propertyValue": 1566,
      "propertyUnit": "U",
      "propertyDivFactor": 10
    }
  ]
}
```

### Error message
```json
{
  "deviceId": "",
  "moduleId": "",
  "messageType": "error",
  "errorCode": "code",
  "errorSeverity": "severity",
  "errorStatus": "status",
  "timestamp": 13456
}
```

### Commissioning message
```json
{
  "deviceId": "",
  "messageType": "commissioning",
  "timestamp": 13456,
  "userId": "",
  "building": {
    "buildingId": "",
    "floor": "",
    "departmentId": "",
    "roomId": null
  }
} 
```

## Commands
**Regular**
```cmd
dotnet IoT.Simulator.dll
```

**Changing the environment**

Linux
```cmd
export ENVIRONMENT=Development
dotnet IoT.Simulator.dll
```

Windows
```cmd
set ENVIRONMENT=Development
dotnet IoT.Simulator.dll
```
